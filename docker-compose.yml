version: '3.4'

services:
  big-api:
    image: abu116/new-api:latest
    platform: linux/amd64  # 指定平台为 amd64
    # build: .
    container_name: big-api
    restart: always
    command: --log-dir /app/logs
    # command: --log-dir /app/logs  # 移除错误的命令行参数
    ports:
      - "127.0.0.1:3004:3000"
    volumes:
      - ./data:/data
      - ./logs:/app/logs
    environment:
      - GIN_MODE=release
      - SQL_DSN=bigaipro:123456789@tcp(rm-rj90nig0z69qweqwsfsf.mysql.rds.aliyuncs.com)/big-api  # 修改此行，或注释掉以使用 SQLite 作为数据库
      - REDIS_CONN_STRING=redis://redis
      - SESSION_SECRET=afsfafsafsafafsdfsd
      - CRYPTO_SECRET=API_POIUYT1212           # 修改为随机字符串
      - TZ=Asia/Shanghai
      - ERROR_LOG_ENABLED=true # 是否启用错误日志记录 (Whether to enable error log recording)
      - BATCH_UPDATE_ENABLED=true
      # ========== 性能优化配置 Performance Optimization ==========
      # 缓存优化 Cache Optimization
      - MEMORY_CACHE_ENABLED=true  # 启用内存缓存，减少 Redis 访问
      - SYNC_FREQUENCY=30  # 渠道缓存同步频率（秒）
      - BATCH_UPDATE_INTERVAL=5  # 批量更新间隔（秒）
      # HTTP 连接池优化 HTTP Connection Pool
      - RELAY_MAX_IDLE_CONNS=1000  # 最大空闲连接数
      - RELAY_MAX_IDLE_CONNS_PER_HOST=200  # 每主机最大空闲连接
      - RELAY_TIMEOUT=120  # 请求超时（秒），0=无限制
      - STREAMING_TIMEOUT=600  # 流式响应超时（秒）
      # 数据库连接池优化 Database Connection Pool
      - SQL_MAX_IDLE_CONNS=100  # 数据库最大空闲连接
      - SQL_MAX_OPEN_CONNS=500  # 数据库最大打开连接
      - SQL_MAX_LIFETIME=300  # 连接最大生命周期（秒）
      - SQL_MAX_IDLE_TIME=60  # 空闲连接最大存活时间（秒）
      # ========== 其他可选配置 Optional Settings ==========
    depends_on:
      - redis
    networks:
      - bigapi-network

  redis:
    image: redis:alpine
    container_name: bigai-redis
    restart: always
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes
    volumes:
      - ./redis-data:/data
    networks:
      - bigapi-network

networks:
  bigapi-network:
    driver: bridge

